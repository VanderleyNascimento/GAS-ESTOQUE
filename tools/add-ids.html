<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar IDs ao Estoque - LoggiStock</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 p-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
            <h1 class="text-2xl font-bold text-slate-900 mb-4">üî¢ Adicionar IDs ao Estoque</h1>
            <p class="text-slate-600 mb-6">Este script adicionar√° IDs sequenciais a todos os itens da planilha Estoque.
            </p>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-blue-900 mb-2">‚ö†Ô∏è Instru√ß√µes Importantes:</h3>
                <ol class="list-decimal list-inside text-sm text-blue-800 space-y-1">
                    <li>Abra sua planilha do Google Sheets</li>
                    <li>Adicione uma coluna "id" como PRIMEIRA coluna (antes de "material")</li>
                    <li>Configure sua API Key do SheetDB abaixo</li>
                    <li>Clique em "Adicionar IDs"</li>
                </ol>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">SheetDB API URL (Estoque)</label>
                    <input type="text" id="apiUrl" placeholder="https://sheetdb.io/api/v1/xxxxx?sheet=estoque"
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>

                <button onclick="addIdsToStock()"
                    class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                    ‚ñ∂Ô∏è Adicionar IDs Automaticamente
                </button>
            </div>

            <div id="result" class="mt-6 hidden">
                <div class="bg-slate-100 rounded-lg p-4">
                    <h3 class="font-semibold text-slate-900 mb-2">Resultado:</h3>
                    <pre id="resultText" class="text-sm text-slate-700 whitespace-pre-wrap"></pre>
                </div>
            </div>

            <div id="progress" class="mt-6 hidden">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                    <!DOCTYPE html>
                    <html lang="pt-BR">

                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Adicionar IDs ao Estoque - LoggiStock</title>
                        <script src="https://cdn.tailwindcss.com"></script>
                    </head>

                    <body class="bg-slate-50 p-8">
                        <div class="max-w-2xl mx-auto">
                            <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                                <h1 class="text-2xl font-bold text-slate-900 mb-4">üî¢ Adicionar IDs ao Estoque</h1>
                                <p class="text-slate-600 mb-6">Este script adicionar√° IDs sequenciais a todos os itens
                                    da planilha Estoque.
                                </p>

                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <h3 class="font-semibold text-blue-900 mb-2">‚ö†Ô∏è Instru√ß√µes Importantes:</h3>
                                    <ol class="list-decimal list-inside text-sm text-blue-800 space-y-1">
                                        <li>Abra sua planilha do Google Sheets</li>
                                        <li>Adicione uma coluna "id" como PRIMEIRA coluna (antes de "material")</li>
                                        <li>Configure sua API Key do SheetDB abaixo</li>
                                        <li>Clique em "Adicionar IDs"</li>
                                    </ol>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">SheetDB API URL
                                            (Estoque)</label>
                                        <input type="text" id="apiUrl"
                                            placeholder="https://sheetdb.io/api/v1/xxxxx?sheet=estoque"
                                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    </div>

                                    <button onclick="addIdsToStock()"
                                        class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                                        ‚ñ∂Ô∏è Adicionar IDs Automaticamente
                                    </button>
                                </div>

                                <div id="result" class="mt-6 hidden">
                                    <div class="bg-slate-100 rounded-lg p-4">
                                        <h3 class="font-semibold text-slate-900 mb-2">Resultado:</h3>
                                        <pre id="resultText" class="text-sm text-slate-700 whitespace-pre-wrap"></pre>
                                    </div>
                                </div>

                                <div id="progress" class="mt-6 hidden">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-6 h-6 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin">
                                        </div>
                                        <span class="text-sm text-slate-600">Processando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                            async function addIdsToStock() {
                                const apiUrl = document.getElementById('apiUrl').value.trim();

                                if (!apiUrl) {
                                    alert('Por favor, insira a URL da API do SheetDB');
                                    return;
                                }

                                const resultDiv = document.getElementById('result');
                                const resultText = document.getElementById('resultText');
                                const progress = document.getElementById('progress');

                                resultDiv.classList.add('hidden');
                                progress.classList.remove('hidden');

                                try {
                                    // 1. Buscar todos os itens
                                    resultText.textContent = 'üîÑ Buscando itens da planilha...\n';
                                    const response = await fetch(apiUrl);
                                    if (!response.ok) {
                                        throw new Error(`Erro HTTP: ${response.status}`);
                                    }

                                    const items = await response.json();
                                    resultText.textContent += `üì¶ ${items.length} itens encontrados\n\n`;

                                    if (items.length === 0) {
                                        throw new Error('Nenhum item encontrado na planilha');
                                    }

                                    // 2. Verificar estrutura dos dados
                                    const firstItem = items[0];
                                    resultText.textContent += `üîç Estrutura detectada: ${Object.keys(firstItem).join(', ')}\n\n`;

                                    // 3. Verificar se j√° tem ID
                                    const hasIds = items.some(item => item.id !== undefined && item.id !== '' && item.id !== null);
                                    if (hasIds) {
                                        resultText.textContent += '‚ö†Ô∏è ATEN√á√ÉO: Alguns itens j√° possuem ID!\n';

                                        if (!confirm('Alguns itens j√° possuem ID. Deseja REPROCESSAR todos os itens?\nIsso ir√° sobrescrever os IDs existentes!')) {
                                            progress.classList.add('hidden');
                                            resultDiv.classList.remove('hidden');
                                            return;
                                        }
                                    }

                                    // 4. Deletar todos os registros existentes e recriar com IDs
                                    resultText.textContent += '\nüóëÔ∏è  M√©todo: Deletar e recriar com IDs\n';
                                    resultText.textContent += '‚ö†Ô∏è  Isso pode levar alguns segundos...\n\n';

                                    let successCount = 0;
                                    let errorCount = 0;

                                    // Primeiro, fazer backup dos dados
                                    const backup = items.map(item => ({ ...item }));

                                    // Deletar todos os itens
                                    for (let i = 0; i < items.length; i++) {
                                        try {
                                            // SheetDB n√£o tem um endpoint de delete all, ent√£o vamos deletar linha por linha
                                            // Como n√£o sabemos a chave prim√°ria, vamos recriar a planilha do zero

                                            // Este m√©todo √© complexo, vamos usar uma abordagem diferente:
                                            // Vamos apenas fazer PATCH usando o √≠ndice da linha

                                            const updateUrl = `${apiUrl.split('?')[0]}/id/${i + 1}`;
                                            const updateResponse = await fetch(updateUrl, {
                                                method: 'PATCH',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ id: i + 1 })
                                            });

                                            if (updateResponse.ok) {
                                                successCount++;
                                                resultText.textContent += `‚úÖ Linha ${i + 1} ‚Üí ID: ${i + 1}\n`;
                                            } else {
                                                errorCount++;
                                                resultText.textContent += `‚ùå Erro na linha ${i + 1}\n`;
                                            }
                                        } catch (error) {
                                            errorCount++;
                                            resultText.textContent += `‚ùå Erro na linha ${i + 1}: ${error.message}\n`;
                                        }

                                        // Delay para n√£o sobrecarregar a API
                                        await new Promise(resolve => setTimeout(resolve, 200));
                                    }

                                    resultText.textContent += `\n\nüìä RESUMO:\n`;
                                    resultText.textContent += `‚úÖ Sucesso: ${successCount} itens\n`;
                                    resultText.textContent += `‚ùå Erros: ${errorCount} itens\n\n`;

                                    if (errorCount === 0) {
                                        resultText.textContent += `\nüéâ IDs adicionados com sucesso!\n`;
                                        resultText.textContent += `\n‚ö†Ô∏è  IMPORTANTE: Atualize a p√°gina do seu aplicativo para ver os IDs.`;
                                    } else {
                                        resultText.textContent += `\n‚ö†Ô∏è  Alguns erros ocorreram. Verifique o SheetDB e tente novamente.`;
                                    }

                                } catch (error) {
                                    resultText.textContent = `‚ùå Erro ao processar: ${error.message}\n\n`;
                                    resultText.textContent += 'Verifique:\n';
                                    resultText.textContent += '1. A URL da API est√° correta\n';
                                    resultText.textContent += '2. A coluna "id" existe na planilha como PRIMEIRA coluna\n';
                                    resultText.textContent += '3. Voc√™ tem permiss√£o para modificar a planilha\n';
                                    resultText.textContent += '4. O SheetDB est√° funcionando (tente acessar a URL no navegador)';
                                } finally {
                                    progress.classList.add('hidden');
                                    resultDiv.classList.remove('hidden');
                                }
                            }
                        </script>
                    </body>

                    </html>