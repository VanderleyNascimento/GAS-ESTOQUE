<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema de Invent√°rio - Loggi Stock">
    <title>Invent√°rio - LoggiStock</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-sm font-semibold text-slate-600">Carregando dados...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-clipboard-check text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900">Invent√°rio</h1>
                        <p class="text-xs text-slate-500">Contagem F√≠sica</p>
                    </div>
                </a>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden sm:block text-right">
                    <p id="user-name" class="text-sm font-semibold text-slate-900">-</p>
                    <p id="user-role" class="text-xs text-slate-500">-</p>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-lg hover:bg-red-50 transition-colors" title="Sair">
                    <i class="fa-solid fa-right-from-bracket text-red-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Cabe√ßalho -->
        <div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl p-6 text-white mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">üìã Gest√£o de Invent√°rio</h2>
                    <p class="text-purple-100 text-sm">Contagem f√≠sica e reconcilia√ß√£o de estoque</p>

                </div>
                <a href="index.html"
                    class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors backdrop-blur-sm">
                    <i class="fa-solid fa-arrow-left mr-2"></i>Voltar
                </a>
            </div>
            <p class="text-purple-200 text-xs mt-3">üîí Acesso: Administradores</p>
        </div>

        <!-- Scanner/Busca -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 mb-6">
            <div class="flex gap-3">
                <input type="text" id="inventory-search" placeholder="Digite o ID ou nome do item..."
                    class="flex-1 px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                <button onclick="Inventory.startCount()"
                    class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                    <i class="fa-solid fa-plus mr-2"></i>Adicionar
                </button>
            </div>
        </div>

        <!-- Lista de itens em invent√°rio -->
        <div id="inventory-list" class="space-y-3 mb-6"></div>

        <!-- Resumo do invent√°rio -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 mb-6">
            <h3 class="font-bold text-lg mb-4">üìä Resumo da Contagem</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <p class="text-3xl font-black text-purple-600" id="inv-total">0</p>
                    <p class="text-xs text-slate-600 mt-1">Itens Contados</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <p class="text-3xl font-black text-green-600" id="inv-sobras">0</p>
                    <p class="text-xs text-slate-600 mt-1">Sobras (+)</p>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <p class="text-3xl font-black text-red-600" id="inv-faltas">0</p>
                    <p class="text-xs text-slate-600 mt-1">Faltas (-)</p>
                </div>
            </div>
            <button onclick="Inventory.finalize()" id="btn-finalize-inventory"
                class="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-check-double mr-2"></i>Finalizar Balan√ßo
            </button>
        </div>

        <!-- Hist√≥rico de Invent√°rios -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100">
            <h3 class="font-bold text-lg mb-4">üïê Hist√≥rico de Invent√°rios</h3>
            <div id="inventory-history"></div>
        </div>
    </main>

    <!-- Modal: Inventory Count -->
    <div id="modal-inventory"
        class="hidden fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 transform transition-all">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-slate-900">Contagem de Estoque</h3>
                <button onclick="document.getElementById('modal-inventory').classList.add('hidden')"
                    class="w-8 h-8 rounded-lg hover:bg-slate-100 transition-colors">
                    <i class="fa-solid fa-xmark text-slate-500"></i>
                </button>
            </div>
            <div id="inventory-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/components.js"></script>
    <script src="js/inventory.js"></script>

    <script>
        // Inventory page initialization
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîß Inventory page loaded');

            // Check authentication
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is admin
            if (user.cargo !== 'Administrador') {
                Components.showToast('Acesso negado: apenas Administradores', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            // Display user info
            document.getElementById('user-name').textContent = user.nome;
            document.getElementById('user-role').textContent = user.cargo;

            // Load data
            try {
                const [stock, movements] = await Promise.all([
                    API.getStock(),
                    API.getMovements()
                ]);

                // Normalize stock data with ID support
                window.stockData = stock.map(item => ({
                    id: parseInt(item.id) || null,
                    material: item.material || '',
                    estoqueAtual: parseInt(item.estoqueAtual) || 0,
                    estoqueCritico: parseInt(item.estoqueCritico) || 0,
                    qtdRetiradas: parseInt(item.qtdRetiradas) || 0,
                    epiAtivo: item.epiAtivo
                }));

                window.movementsData = movements;

                console.log('‚úÖ Data loaded:', window.stockData.length, 'items');

                // Hide loading
                document.getElementById('loading').style.display = 'none';

                // Load inventory history
                if (typeof Inventory !== 'undefined') {
                    Inventory.loadHistory();
                    Inventory.renderCurrentItems();
                }

                // Setup search
                const searchInput = document.getElementById('inventory-search');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const searchTerm = e.target.value.trim();
                            if (searchTerm) {
                                // Try to find by ID or name
                                let item = null;

                                // Check if it's a number (ID)
                                if (/^\d+$/.test(searchTerm)) {
                                    item = window.stockData.find(i => i.id === parseInt(searchTerm));
                                }

                                // If not found by ID, try by name
                                if (!item) {
                                    item = window.stockData.find(i =>
                                        i.material.toLowerCase().includes(searchTerm.toLowerCase())
                                    );
                                }

                                if (item) {
                                    Inventory.addItem(item);
                                    e.target.value = '';
                                } else {
                                    Components.showToast('Item n√£o encontrado', 'error');
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading data:', error);
                Components.showToast('Erro ao carregar dados', 'error');
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>